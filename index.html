<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>App Turística — Mapa con Geolocalización</title>

  <!-- Tailwind CSS CDN (play-cdn) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Leaflet CSS & JS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-sA+e2w6kGm1tYQvZf1Q6B6gW9qvQ2n4h2u2q0n0jv6A=" crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-o9N1j6tGvJX8m+4n8g3/0l3jA2f6q3q2b3yZl+o6u0I=" crossorigin=""></script>

  <style>
    /* pequeño ajuste para el mapa */
    #map { height: 100vh; }
    /* ajusta tamaño de imagen en popups */
    .poi-img { max-width: 160px; max-height: 100px; display:block; margin-top:6px; border-radius:6px; }
    /* para que el panel lateral quede por encima en pantallas pequeñas */
    .side-panel { z-index: 1000; }
  </style>
</head>
<body class="bg-gray-50 text-gray-800">

  <div class="flex h-screen">
    <!-- Panel lateral -->
    <aside class="side-panel w-80 bg-white border-r border-gray-200 p-4 hidden md:block">
      <h1 class="text-xl font-semibold mb-2">App Turística</h1>
      <p class="text-sm text-gray-600 mb-3">Explora puntos de interés, añade los tuyos y localízate en el mapa.</p>

      <div class="mb-3">
        <button id="btn-locate" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 rounded">Ir a mi ubicación</button>
      </div>

      <div class="mb-3">
        <input id="search" type="search" placeholder="Buscar POI o descripción..." class="w-full border rounded p-2"/>
      </div>

      <div class="mb-3">
        <label class="block text-sm text-gray-700 mb-1">Filtrar por categoría</label>
        <select id="filter-category" class="w-full border rounded p-2">
          <option value="">Todas</option>
        </select>
      </div>

      <div class="mb-3 flex gap-2">
        <button id="btn-show-add" class="flex-1 bg-green-600 text-white py-2 rounded">Añadir POI</button>
        <button id="btn-export" class="flex-1 bg-gray-200 text-gray-800 py-2 rounded">Exportar</button>
      </div>

      <div class="mb-3">
        <input id="import-file" type="file" accept="application/json" class="text-sm"/>
      </div>

      <hr class="my-3"/>

      <div id="poi-list" class="overflow-auto" style="max-height:55vh;"></div>

      <p class="mt-3 text-xs text-gray-500">Los POIs se guardan localmente en tu navegador.</p>
    </aside>

    <!-- Mapa -->
    <main class="flex-1 relative">
      <div id="map"></div>

      <!-- Botón panel para móviles -->
      <div class="md:hidden absolute top-4 left-4 z-50">
        <button id="toggle-side" class="bg-white border rounded p-2 shadow">Menu</button>
      </div>

      <!-- Formulario modal añadir POI -->
      <div id="modal" class="fixed inset-0 bg-black bg-opacity-40 hidden items-center justify-center p-4">
        <div class="bg-white rounded shadow-lg w-full max-w-lg p-4">
          <h2 class="text-lg font-semibold mb-2">Añadir punto de interés</h2>
          <form id="poi-form" class="space-y-2">
            <div>
              <label class="block text-sm">Nombre</label>
              <input id="poi-name" required class="w-full border rounded p-2"/>
            </div>
            <div>
              <label class="block text-sm">Descripción</label>
              <textarea id="poi-desc" class="w-full border rounded p-2" rows="2"></textarea>
            </div>
            <div>
              <label class="block text-sm">Categoría</label>
              <input id="poi-cat" placeholder="ej: Monumento, Museo, Restaurante" class="w-full border rounded p-2"/>
            </div>
            <div>
              <label class="block text-sm">Foto (URL)</label>
              <input id="poi-img" placeholder="https://..." class="w-full border rounded p-2"/>
            </div>
            <div class="text-sm text-gray-600">Puedes hacer click en el mapa para fijar la ubicación; si no, se utilizará la ubicación del centro del mapa.</div>
            <div class="flex gap-2 justify-end mt-3">
              <button type="button" id="cancel-modal" class="px-4 py-2 rounded border">Cancelar</button>
              <button type="submit" class="px-4 py-2 rounded bg-blue-600 text-white">Guardar POI</button>
            </div>
          </form>
        </div>
      </div>
    </main>
  </div>

<script>
/* ---- App JS ---- */

// Utils: calcular distancia entre dos coordenadas (haversine), en km
function distanceKm(lat1, lon1, lat2, lon2) {
  const R = 6371; // km
  const toRad = v => v * Math.PI / 180;
  const dLat = toRad(lat2 - lat1);
  const dLon = toRad(lon2 - lon1);
  const a = Math.sin(dLat/2)*Math.sin(dLat/2) +
            Math.cos(toRad(lat1))*Math.cos(toRad(lat2)) *
            Math.sin(dLon/2)*Math.sin(dLon/2);
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  return R * c;
}

// Estado inicial
let state = {
  pois: [], // {id, name, desc, cat, img, lat, lng}
  userPos: null,
  mapClickLatLng: null
};

// DOM references
const poiListEl = document.getElementById('poi-list');
const btnLocate = document.getElementById('btn-locate');
const btnShowAdd = document.getElementById('btn-show-add');
const modal = document.getElementById('modal');
const poiForm = document.getElementById('poi-form');
const btnCancelModal = document.getElementById('cancel-modal');
const searchInput = document.getElementById('search');
const filterCategory = document.getElementById('filter-category');
const btnExport = document.getElementById('btn-export');
const importFile = document.getElementById('import-file');
const toggleSide = document.getElementById('toggle-side');
const sidePanel = document.querySelector('aside.side-panel');

// Map setup
const map = L.map('map', { center: [40.0708, -2.1374], zoom: 13 }); // centro por defecto (Cuenca, ejemplo)
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '© OpenStreetMap contributors'
}).addTo(map);

const markersLayer = L.layerGroup().addTo(map);

// sample POIs (si no hay datos en localStorage)
const samplePOIs = [
  {
    id: cryptoRandomId(),
    name: "Catedral de Cuenca",
    desc: "Catedral gótica con torres espectaculares.",
    cat: "Monumento",
    img: "https://upload.wikimedia.org/wikipedia/commons/7/74/Catedral_de_Cuenca%2C_Espa%C3%B1a.jpg",
    lat: 40.0786, lng: -2.1301
  },
  {
    id: cryptoRandomId(),
    name: "Casas Colgadas",
    desc: "Famosas casas colgantes sobre el valle del río Huécar.",
    cat: "Monumento",
    img: "https://upload.wikimedia.org/wikipedia/commons/e/e0/Casas_Colgadas_Cuenca.jpg",
    lat: 40.0779, lng: -2.1308
  },
  {
    id: cryptoRandomId(),
    name: "Museo de Arte Abstracto",
    desc: "Colección de arte moderno y abstracto.",
    cat: "Museo",
    img: "",
    lat: 40.0792, lng: -2.1315
  }
];

// Helpers
function cryptoRandomId() {
  return Math.random().toString(36).slice(2,9);
}

function saveState() {
  localStorage.setItem('tour_pois_v1', JSON.stringify(state.pois));
}

function loadState() {
  const raw = localStorage.getItem('tour_pois_v1');
  if (raw) {
    try {
      state.pois = JSON.parse(raw);
      return;
    } catch(e) {
      console.warn('Error parsing POIs', e);
    }
  }
  // si no hay nada, cargar muestra
  state.pois = samplePOIs;
  saveState();
}

function populateCategoryFilter() {
  const cats = [...new Set(state.pois.map(p => p.cat).filter(Boolean))].sort();
  filterCategory.innerHTML = '<option value="">Todas</option>';
  cats.forEach(c => {
    const opt = document.createElement('option');
    opt.value = c;
    opt.textContent = c;
    filterCategory.appendChild(opt);
  });
}

function renderMarkers() {
  markersLayer.clearLayers();
  state.pois.forEach(p => {
    const marker = L.marker([p.lat, p.lng]).addTo(markersLayer);
    const imgHtml = p.img ? `<img src="${p.img}" alt="${escapeHtml(p.name)}" class="poi-img">` : '';
    const distText = state.userPos ? `<div><strong>Distancia:</strong> ${distanceKm(state.userPos.lat, state.userPos.lng, p.lat, p.lng).toFixed(2)} km</div>` : '';
    const popupHtml = `
      <div style="min-width:180px">
        <strong>${escapeHtml(p.name)}</strong>
        <div style="font-size:0.9em; margin-top:4px;">${escapeHtml(p.desc || '')}</div>
        <div style="font-size:0.85em; margin-top:6px;"><em>${escapeHtml(p.cat || '')}</em></div>
        ${imgHtml}
        ${distText}
        <div style="margin-top:6px;">
          <a href="https://www.google.com/maps/dir/?api=1&destination=${p.lat},${p.lng}" target="_blank">Ir (Google Maps)</a>
        </div>
      </div>
    `;
    marker.bindPopup(popupHtml);
    marker.on('click', () => {
      // center when clicked in list maybe
    });
  });
}

function renderList() {
  const q = searchInput.value.trim().toLowerCase();
  const catFilter = filterCategory.value;
  poiListEl.innerHTML = '';

  const filtered = state.pois.filter(p => {
    const matchesQ = q === '' || (p.name && p.name.toLowerCase().includes(q)) || (p.desc && p.desc.toLowerCase().includes(q)) || (p.cat && p.cat.toLowerCase().includes(q));
    const matchesCat = !catFilter || p.cat === catFilter;
    return matchesQ && matchesCat;
  });

  if (filtered.length === 0) {
    poiListEl.innerHTML = '<p class="text-sm text-gray-500">No hay puntos que coincidan.</p>';
    return;
  }

  filtered.forEach(p => {
    const item = document.createElement('div');
    item.className = 'p-2 border-b hover:bg-gray-50 cursor-pointer';
    const dist = state.userPos ? `${distanceKm(state.userPos.lat, state.userPos.lng, p.lat, p.lng).toFixed(2)} km` : '-';
    item.innerHTML = `
      <div class="flex justify-between items-start">
        <div>
          <div class="font-semibold">${escapeHtml(p.name)}</div>
          <div class="text-xs text-gray-600">${escapeHtml(p.cat || '')}</div>
          <div class="text-xs text-gray-500 mt-1">${escapeHtml(p.desc || '')}</div>
        </div>
        <div class="text-right">
          <div class="text-xs text-gray-500">${dist}</div>
          <div class="mt-2 flex gap-1">
            <button class="text-xs px-2 py-1 bg-blue-600 text-white rounded btn-center">Ver</button>
            <button class="text-xs px-2 py-1 bg-red-500 text-white rounded btn-delete">Borrar</button>
          </div>
        </div>
      </div>
    `;
    // click handlers
    const btnCenter = item.querySelector('.btn-center');
    btnCenter.addEventListener('click', (ev) => {
      ev.stopPropagation();
      map.setView([p.lat, p.lng], 17, { animate: true });
      // open popup
      markersLayer.eachLayer(m => {
        if (m.getLatLng && Math.abs(m.getLatLng().lat - p.lat) < 1e-6 && Math.abs(m.getLatLng().lng - p.lng) < 1e-6) {
          m.openPopup();
        }
      });
    });
    const btnDelete = item.querySelector('.btn-delete');
    btnDelete.addEventListener('click', (ev) => {
      ev.stopPropagation();
      if (confirm(`¿Borrar "${p.name}"?`)) {
        state.pois = state.pois.filter(x => x.id !== p.id);
        saveState();
        populateCategoryFilter();
        renderMarkers();
        renderList();
      }
    });

    poiListEl.appendChild(item);
  });
}

function escapeHtml(str='') {
  return String(str)
    .replace(/&/g, '&amp;')
    .replace(/</g,'&lt;')
    .replace(/>/g,'&gt;')
    .replace(/"/g,'&quot;');
}

// Eventos UI
btnLocate.addEventListener('click', () => {
  if (!navigator.geolocation) {
    alert('Geolocalización no soportada por tu navegador.');
    return;
  }
  navigator.geolocation.getCurrentPosition(pos => {
    const { latitude: lat, longitude: lng } = pos.coords;
    state.userPos = { lat, lng };
    // marque / centre
    if (!state._userMarker) {
      state._userMarker = L.circleMarker([lat,lng], { radius:8, color:'#0ea5e9' }).addTo(map);
    } else {
      state._userMarker.setLatLng([lat,lng]);
    }
    map.setView([lat,lng], 15, { animate: true });
    renderMarkers();
    renderList();
  }, err => {
    alert('No se pudo obtener la posición: ' + (err.message || err.code));
  }, { enableHighAccuracy: true });
});

btnShowAdd.addEventListener('click', () => {
  openModal();
});

// abrir / cerrar modal
function openModal() {
  modal.classList.remove('hidden');
  modal.style.display = 'flex';
}
function closeModal() {
  modal.classList.add('hidden');
  modal.style.display = 'none';
  poiForm.reset();
  state.mapClickLatLng = null;
}

btnCancelModal.addEventListener('click', closeModal);

poiForm.addEventListener('submit', (ev) => {
  ev.preventDefault();
  const name = document.getElementById('poi-name').value.trim();
  const desc = document.getElementById('poi-desc').value.trim();
  const cat = document.getElementById('poi-cat').value.trim();
  const img = document.getElementById('poi-img').value.trim();

  let latlng = state.mapClickLatLng;
  if (!latlng) {
    // coger centro del mapa
    latlng = map.getCenter();
  }
  const poi = {
    id: cryptoRandomId(),
    name, desc, cat, img,
    lat: parseFloat(latlng.lat),
    lng: parseFloat(latlng.lng)
  };
  state.pois.push(poi);
  saveState();
  populateCategoryFilter();
  renderMarkers();
  renderList();
  closeModal();
});

// click en el mapa para fijar coordenadas al añadir
map.on('click', (e) => {
  // si el modal está abierto, fijamos
  if (!modal.classList.contains('hidden')) {
    state.mapClickLatLng = e.latlng;
    alert('Ubicación fijada en el mapa para el nuevo POI.');
  }
});

// busqueda y filtro
searchInput.addEventListener('input', () => renderList());
filterCategory.addEventListener('change', () => renderList());

// export/import
btnExport.addEventListener('click', () => {
  const dataStr = JSON.stringify(state.pois, null, 2);
  const blob = new Blob([dataStr], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'pois_export.json';
  a.click();
  URL.revokeObjectURL(url);
});

importFile.addEventListener('change', (ev) => {
  const f = ev.target.files[0];
  if (!f) return;
  const reader = new FileReader();
  reader.onload = (e) => {
    try {
      const imported = JSON.parse(e.target.result);
      if (!Array.isArray(imported)) throw new Error('Formato incorrecto (se esperaba un array de POIs).');
      // agregar con ids si faltan
      imported.forEach(p => {
        if (!p.id) p.id = cryptoRandomId();
        // validar lat/lng mínimos
        p.lat = parseFloat(p.lat);
        p.lng = parseFloat(p.lng);
      });
      // confirm
      if (confirm(`Importar ${imported.length} POIs y añadirlos a los existentes?`)) {
        state.pois = state.pois.concat(imported);
        saveState();
        populateCategoryFilter();
        renderMarkers();
        renderList();
      }
    } catch(err) {
      alert('Error importando: ' + err.message);
    }
  };
  reader.readAsText(f);
});

// toggle panel para móviles
toggleSide.addEventListener('click', () => {
  if (sidePanel.classList.contains('hidden')) {
    sidePanel.classList.remove('hidden');
  } else {
    sidePanel.classList.add('hidden');
  }
});

// helper: cargar todo al inicio
function initApp() {
  loadState();
  populateCategoryFilter();
  renderMarkers();
  renderList();

  // Detecta posición automáticamente si el usuario ya la permitió antes
  if (navigator.permissions) {
    navigator.permissions.query({ name: 'geolocation' }).then(res => {
      if (res.state === 'granted') {
        btnLocate.click();
      }
    }).catch(()=>{});
  }
}

// pequeñas mejoras: abrir modal si el usuario hace doble clic en mapa (alternativa)
map.on('dblclick', () => openModal());

// inicio
initApp();

/* --- fin JS --- */
</script>
</body>
</html>
