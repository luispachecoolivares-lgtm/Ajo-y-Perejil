<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Ajo y Perejil</title>
<meta name="description" content="Ajo y Perejil ‚Äî gesti√≥n de recetas, men√∫s, reservas y contabilidad para una sociedad gastron√≥mica." />
<meta name="theme-color" content="#ffffff" />
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#ffffff; --muted:#6b7280; --icon:#374151;
    --soft-0: rgba(59,130,246,0.12);
    --soft-1: rgba(16,185,129,0.12);
    --soft-2: rgba(245,158,11,0.12);
    --soft-3: rgba(239,68,68,0.08);
    --soft-4: rgba(139,92,246,0.10);
    --soft-5: rgba(251,113,133,0.10);
    --soft-6: rgba(6,182,212,0.10);
    --soft-7: rgba(249,115,22,0.10);
  }
  html,body{height:100%}
  body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:#0f172a;margin:0;-webkit-font-smoothing:antialiased}
  .safe-bottom{padding-bottom:calc(env(safe-area-inset-bottom)+14px)}
  .container{max-width:980px;margin:0 auto;padding:16px;padding-bottom:110px}
  .card{background:#fff;border-radius:14px;box-shadow:0 6px 18px rgba(16,24,40,0.06);padding:14px;margin-bottom:12px}
  .nav{position:fixed;left:0;right:0;bottom:0;display:flex;justify-content:space-around;align-items:center;padding:10px calc(env(safe-area-inset-left)+8px) calc(env(safe-area-inset-bottom)+12px) calc(env(safe-area-inset-right)+8px);background:rgba(255,255,255,0.98);border-top:1px solid rgba(16,24,40,0.04);backdrop-filter:blur(6px)}
  .nav-btn{display:flex;flex-direction:column;align-items:center;gap:4px;font-size:12px;color:var(--muted);background:none;border:0;padding:6px;border-radius:10px}
  .nav-btn.active{color:var(--icon);font-weight:600}
  .icon{width:22px;height:22px;display:block}
  .hidden{display:none}
  .field{width:100%;padding:10px;border:1px solid #e5e7eb;border-radius:10px}
  .btn{padding:10px 12px;border-radius:12px;font-weight:600}
  .btn-primary{background:#0ea5a4;color:white}
  .btn-ghost{background:white;border:1px solid #e5e7eb}
  .small{font-size:13px;color:var(--muted)}
  /* categories bubbles */
  .cat-grid{display:flex;flex-wrap:wrap;gap:12px;justify-content:center;padding-top:12px}
  .cat-card{width:120px;height:90px;border-radius:12px;display:flex;align-items:center;justify-content:center;color:white;font-weight:700;position:relative;transition:transform .25s,opacity .25s}
  .cat-actions{display:flex;gap:8px;justify-content:center;margin-top:8px}
  .cat-btn{padding:6px 8px;border-radius:8px;border:0;font-weight:600;color:white}
  .fade-in{animation:fadeIn .28s ease}
  .fade-out{animation:fadeOut .28s ease forwards}
  @keyframes fadeIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:none}}
  @keyframes fadeOut{from{opacity:1;transform:none}to{opacity:0;transform:translateY(-6px) scale(.98)}}
  /* table */
  table{width:100%;border-collapse:collapse}
  th,td{padding:10px 8px;text-align:left;border-bottom:1px solid #f1f5f9}
  thead th{font-weight:700;font-size:13px;color:var(--muted)}
  tfoot td{font-weight:700}
  /* calendar */
  .cal {display:grid;grid-template-columns:repeat(7,1fr);gap:6px}
  .cal-day{min-height:74px;border-radius:10px;padding:8px;background:linear-gradient(180deg,#ffffff,#fbfbfd);box-shadow:inset 0 0 0 1px rgba(15,23,42,0.02)}
  .cal-day.other{opacity:.45}
  .cal-day .date{font-weight:700;margin-bottom:6px}
  .dot{display:inline-block;width:8px;height:8px;border-radius:50%}
  .badge{display:inline-block;padding:4px 8px;border-radius:999px;font-size:12px}
  .pill{padding:6px 8px;border-radius:999px;font-weight:600}
  .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.35);display:flex;align-items:center;justify-content:center;z-index:9999}
  .modal{background:white;border-radius:12px;padding:16px;max-width:820px;width:92%;box-shadow:0 10px 30px rgba(0,0,0,0.15)}
  .muted{color:var(--muted)}
  @media (max-width:520px){ .cat-card{width:100px;height:76px;font-size:13px} .container{padding:12px} .cal-day{min-height:64px} }
</style>
</head>
<body class="safe-bottom">
  <div class="container" id="app">
    <header class="flex items-center justify-between mb-4">
      <div>
        <h1 class="text-lg font-extrabold">Ajo y Perejil</h1>
        <div class="small">Recetas ¬∑ Contabilidad ¬∑ Reservas ¬∑ Balances</div>
      </div>
      <div>
        <button id="btnOptions" class="btn btn-ghost">Opciones</button>
      </div>
    </header>

    <!-- Inicio -->
    <section id="inicio" class="card">
      <div class="flex justify-between items-start">
        <div>
          <div class="small">Resumen</div>
          <div class="text-xl font-semibold">Panel</div>
        </div>
        <div class="text-right">
          <div class="small">Saldo</div>
          <div id="saldoGlobal" class="text-lg font-bold">0,00 ‚Ç¨</div>
        </div>
      </div>

      <div class="grid grid-cols-3 gap-3 mt-4">
        <div class="text-center p-3 rounded-lg bg-white">
          <div class="small">Recetas</div>
          <div id="cntRecetas" class="text-lg font-semibold">0</div>
        </div>
        <div class="text-center p-3 rounded-lg bg-white">
          <div class="small">Men√∫s</div>
          <div id="cntMenus" class="text-lg font-semibold">0</div>
        </div>
        <div class="text-center p-3 rounded-lg bg-white">
          <div class="small">Reservas</div>
          <div id="cntReservas" class="text-lg font-semibold">0</div>
        </div>
      </div>
    </section>

    <!-- Recetas -->
    <section id="recetas" class="card hidden">
      <div class="flex items-center justify-between mb-3">
        <div class="font-semibold">Recetas</div>
        <div class="small">Guarda y muestra tus recetas</div>
      </div>

      <div class="grid md:grid-cols-2 gap-4">
        <form id="formReceta" class="space-y-2">
          <input id="rNombre" class="field" placeholder="Nombre de la receta" required>
          <textarea id="rIngredientes" class="field" rows="4" placeholder="Ingredientes (una por l√≠nea)"></textarea>
          <textarea id="rInstrucciones" class="field" rows="5" placeholder="Instrucciones"></textarea>
          <div class="flex gap-2">
            <button class="btn btn-primary" type="submit">Guardar receta</button>
            <button id="limpiarRec" type="button" class="btn btn-ghost">Limpiar</button>
          </div>
        </form>

        <div>
          <div class="small mb-2">Recetas guardadas</div>
          <div id="listRecetas" class="space-y-2"></div>

          <div id="detalleReceta" class="mt-4 hidden card">
            <div class="flex justify-between items-start">
              <div>
                <div id="dNombre" class="text-lg font-semibold"></div>
                <div class="small muted" id="dMeta"></div>
              </div>
              <div>
                <button id="editRecBtn" class="btn btn-ghost">Editar</button>
                <button id="delRecBtn" class="btn btn-ghost">Borrar</button>
              </div>
            </div>
            <hr class="my-2" />
            <div>
              <div class="font-semibold">Ingredientes</div>
              <pre id="dIngredientes" class="small text-gray-700 whitespace-pre-wrap"></pre>
              <div class="font-semibold mt-2">Instrucciones</div>
              <pre id="dInstrucciones" class="small text-gray-700 whitespace-pre-wrap"></pre>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Categor√≠as -->
    <section id="categorias" class="card hidden">
      <div class="flex items-center justify-between">
        <div class="font-semibold">Categor√≠as</div>
        <div class="small">Colores autom√°ticos</div>
      </div>

      <div class="mt-3 flex gap-2">
        <input id="newCatName" class="field flex-1" placeholder="Nombre nueva categor√≠a">
        <button id="addCatBtn" class="btn btn-primary">‚ûï A√±adir</button>
      </div>

      <div id="catGrid" class="cat-grid mt-3"></div>
    </section>

    <!-- Contabilidad -->
    <section id="contabilidad" class="card hidden">
      <div class="flex items-center justify-between mb-3">
        <div class="font-semibold">Contabilidad</div>
        <div class="small">Registra ingresos y gastos</div>
      </div>

      <form id="formMov" class="space-y-2 mb-4">
        <input type="hidden" id="movId">
        <div class="grid grid-cols-3 gap-2">
          <select id="movTipo" class="field col-span-1">
            <option value="ingreso">Ingreso</option>
            <option value="gasto">Gasto</option>
          </select>
          <input id="movImporte" type="number" step="0.01" class="field col-span-1" placeholder="Importe (‚Ç¨)" required>
          <input id="movFecha" type="date" class="field col-span-1" value="">
        </div>
        <div class="grid grid-cols-2 gap-2">
          <select id="movCategoria" class="field"></select>
          <input id="movConcepto" class="field" placeholder="Concepto">
        </div>
        <div class="flex gap-2">
          <button class="btn btn-primary" type="submit">Registrar</button>
          <button id="limpiarMov" type="button" class="btn btn-ghost">Limpiar</button>
        </div>
      </form>

      <div class="mb-3 flex items-center justify-between gap-2">
        <div class="small">Filtrar per√≠odo:</div>
        <div class="flex gap-2 items-center">
          <select id="periodoSelect" class="field w-auto">
            <option value="all">Todo</option>
            <option value="30">√öltimos 30 d√≠as</option>
            <option value="90">√öltimos 90 d√≠as</option>
            <option value="year">Este a√±o</option>
            <option value="custom">Personalizado</option>
          </select>
          <input id="periodFrom" type="date" class="field" style="display:none">
          <input id="periodTo" type="date" class="field" style="display:none">
          <button id="aplicarPeriodo" class="btn btn-ghost">Aplicar</button>
        </div>
      </div>

      <div class="small text-gray-500 mb-2">√öltimos movimientos</div>
      <div id="listaMovimientos" class="space-y-2 mb-4"></div>

      <div class="font-semibold mb-2">Balances por categor√≠a</div>
      <div class="overflow-x-auto">
        <table id="tablaBalances" class="w-full">
          <thead><tr><th>Categor√≠a</th><th>Ingresos (‚Ç¨)</th><th>Gastos (‚Ç¨)</th><th>Saldo (‚Ç¨)</th></tr></thead>
          <tbody></tbody>
          <tfoot><tr><td>Total</td><td id="sumIngresos">0,00</td><td id="sumGastos">0,00</td><td id="sumSaldo">0,00</td></tr></tfoot>
        </table>
      </div>
    </section>

    <!-- Reservas -->
    <section id="reservas" class="card hidden">
      <div class="flex items-center justify-between mb-3">
        <div class="font-semibold">Reservas</div>
        <div class="small">Calendario y formulario</div>
      </div>

      <div class="grid md:grid-cols-2 gap-4">
        <div>
          <div class="flex items-center justify-between mb-2">
            <div>
              <button id="calPrev" class="btn btn-ghost">‚óÄ</button>
              <span id="calMonth" class="font-semibold mx-3"></span>
              <button id="calNext" class="btn btn-ghost">‚ñ∂</button>
            </div>
            <div class="small muted">Mes actual y navegaci√≥n</div>
          </div>
          <div class="grid grid-cols-7 gap-2 text-center muted small mb-2">
            <div>Dom</div><div>Lun</div><div>Mar</div><div>Mi√©</div><div>Jue</div><div>Vie</div><div>S√°b</div>
          </div>
          <div id="calendar" class="cal"></div>
          <div id="listaReservasDia" class="mt-3"></div>
        </div>

        <div>
          <form id="formRes" class="space-y-2">
            <input id="resNombre" class="field" placeholder="Nombre" required>
            <div class="grid grid-cols-2 gap-2">
              <input id="resFecha" type="date" class="field" required>
              <input id="resHora" type="time" class="field" value="20:00">
            </div>
            <input id="resPax" type="number" min="1" class="field" placeholder="Comensales" value="2">
            <div class="flex gap-2">
              <button class="btn btn-primary" type="submit">Guardar</button>
              <button id="limpiarRes" type="button" class="btn btn-ghost">Limpiar</button>
            </div>
          </form>
          <div class="small text-gray-500 mt-3">Pr√≥ximas reservas</div>
          <div id="listaReservas" class="mt-2 small"></div>
        </div>
      </div>
    </section>

  </div>

  <!-- Bottom nav -->
  <nav class="nav" role="navigation" aria-label="Navegaci√≥n principal">
    <button class="nav-btn active" data-target="inicio" title="Inicio">
      <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="color:#374151"><path d="M3 12l9-9 9 9" stroke-linecap="round" stroke-linejoin="round"/><path d="M9 21V9h6v12" stroke-linecap="round" stroke-linejoin="round"/></svg>
      <span class="small">Inicio</span>
    </button>
    <button class="nav-btn" data-target="recetas" title="Recetas">
      <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="color:#374151"><path d="M3 7h18M7 3v4" stroke-linecap="round" stroke-linejoin="round"/></svg>
      <span class="small">Recetas</span>
    </button>
    <button class="nav-btn" data-target="categorias" title="Categor√≠as">
      <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="color:#374151"><circle cx="12" cy="12" r="3"/><path d="M12 2v2M12 20v2M2 12h2M20 12h2" stroke-linecap="round" stroke-linejoin="round"/></svg>
      <span class="small">Categor√≠as</span>
    </button>
    <button class="nav-btn" data-target="contabilidad" title="Contabilidad">
      <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="color:#374151"><path d="M12 8v8"/><path d="M8 12h8"/><rect x="3" y="3" width="18" height="18" rx="2"/></svg>
      <span class="small">Cuenta</span>
    </button>
    <button class="nav-btn" data-target="reservas" title="Reservas">
      <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="color:#374151"><rect x="3" y="4" width="18" height="18" rx="2"/><path d="M16 2v4M8 2v4"/></svg>
      <span class="small">Reservas</span>
    </button>
    <button class="nav-btn" data-target="balances" title="Balances">
      <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="color:#374151"><path d="M3 3v18h18"/><path d="M7 13l3-6 3 12 3-8"/></svg>
      <span class="small">Balances</span>
    </button>
  </nav>

<!-- Modal placeholder -->
<div id="modalRoot"></div>

<script>
/* ---------- App JS: local-only, single file ---------- */
document.addEventListener('DOMContentLoaded', ()=>{

/* Keys */
const K_REC = 'ajop_recetas_v4';
const K_CAT = 'ajop_cats_v4';
const K_MOV = 'ajop_mov_v4';
const K_RES = 'ajop_res_v4';

/* Paleta base (colores principales) and soft backgrounds */
const palette = ['#3b82f6','#10b981','#f59e0b','#ef4444','#8b5cf6','#fb7185','#06b6d4','#f97316'];
const soft = ['var(--soft-0)','var(--soft-1)','var(--soft-2)','var(--soft-3)','var(--soft-4)','var(--soft-5)','var(--soft-6)','var(--soft-7)'];

/* Helpers */
const $ = (s,root=document) => root.querySelector(s);
const $all = (s,root=document) => Array.from(root.querySelectorAll(s));
const esc = s => (s||'').toString().replace(/[&<>"]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));
const uid = ()=> Date.now().toString(36)+Math.random().toString(36).slice(2,6);

/* Load storage */
let recetas = JSON.parse(localStorage.getItem(K_REC) || '[]');
let categories = JSON.parse(localStorage.getItem(K_CAT) || '["Cuotas","Eventos","Compras","Otros"]');
let movimientos = JSON.parse(localStorage.getItem(K_MOV) || '[]');
let reservas = JSON.parse(localStorage.getItem(K_RES) || '[]');

function saveAll(){ localStorage.setItem(K_REC, JSON.stringify(recetas)); localStorage.setItem(K_CAT, JSON.stringify(categories)); localStorage.setItem(K_MOV, JSON.stringify(movimientos)); localStorage.setItem(K_RES, JSON.stringify(reservas)); }

/* Navigation */
$all('.nav-btn').forEach(btn=> btn.addEventListener('click', ()=>{
  $all('.nav-btn').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active'); showSection(btn.dataset.target);
}));
function showSection(id){
  $all('section').forEach(s=> s.classList.add('hidden'));
  const el = $('#'+id); if(el) el.classList.remove('hidden');
  if(id==='inicio') renderInicio();
  if(id==='recetas') renderRecetas();
  if(id==='categorias') renderCategorias();
  if(id==='contabilidad') renderMovimientos();
  if(id==='reservas') renderReservas();
  if(id==='balances') renderBalances();
  window.scrollTo({top:0,behavior:'smooth'});
}

/* Inicio */
function renderInicio(){
  $('#cntRecetas').textContent = recetas.length;
  $('#cntMenus').textContent = 0;
  $('#cntReservas').textContent = reservas.length;
  updateGlobalSaldo();
}

/* ---------- RECETAS ---------- */
$('#formReceta').addEventListener('submit', e=>{
  e.preventDefault();
  const nombre = $('#rNombre').value.trim();
  const ing = $('#rIngredientes').value.trim();
  const ins = $('#rInstrucciones').value.trim();
  if(!nombre) return alert('Nombre requerido');
  const newRec = { id: uid(), nombre, ingredientes: ing, instrucciones: ins, created: new Date().toISOString() };
  recetas.unshift(newRec);
  saveAll();
  $('#formReceta').reset();
  renderRecetas();
  renderInicio();
});
$('#limpiarRec').addEventListener('click', ()=> $('#formReceta').reset());

function renderRecetas(){
  const list = $('#listRecetas'); list.innerHTML = '';
  if(recetas.length===0){ list.innerHTML = '<div class="small muted">No hay recetas</div>'; return; }
  recetas.forEach(r=>{
    const btn = document.createElement('button');
    btn.className = 'btn btn-ghost w-full text-left';
    btn.style.justifyContent = 'space-between';
    btn.innerHTML = `<span>${esc(r.nombre)}</span><span class="small muted">${new Date(r.created).toLocaleDateString()}</span>`;
    btn.addEventListener('click', ()=> showDetalleReceta(r.id));
    list.appendChild(btn);
  });
}

function showDetalleReceta(id){
  const r = recetas.find(x=>x.id===id); if(!r) return;
  $('#detalleReceta').classList.remove('hidden');
  $('#dNombre').textContent = r.nombre;
  $('#dMeta').textContent = `Creada: ${new Date(r.created).toLocaleString()}`;
  $('#dIngredientes').textContent = r.ingredientes || '(sin ingredientes)';
  $('#dInstrucciones').textContent = r.instrucciones || '(sin instrucciones)';
  // set actions
  $('#editRecBtn').onclick = ()=> openEditReceta(r.id);
  $('#delRecBtn').onclick = ()=> {
    // delete silently (no prompt), re-render
    recetas = recetas.filter(x=>x.id!==r.id);
    saveAll(); renderRecetas(); $('#detalleReceta').classList.add('hidden'); renderInicio();
  };
}

function openEditReceta(id){
  const r = recetas.find(x=>x.id===id); if(!r) return;
  // populate form for edit
  $('#rNombre').value = r.nombre;
  $('#rIngredientes').value = r.ingredientes;
  $('#rInstrucciones').value = r.instrucciones;
  // remove old listener and replace submit behavior to save edit
  const form = $('#formReceta');
  // temporarily set movId in dataset
  form.dataset.editing = r.id;
  // change button text
  const saveBtn = form.querySelector('button[type="submit"]');
  const prevText = saveBtn.textContent;
  saveBtn.textContent = 'Guardar cambios';
  const onSubmit = (e)=>{
    e.preventDefault();
    const nombre = $('#rNombre').value.trim();
    if(!nombre){ alert('Nombre requerido'); return; }
    r.nombre = nombre;
    r.ingredientes = $('#rIngredientes').value.trim();
    r.instrucciones = $('#rInstrucciones').value.trim();
    saveAll();
    renderRecetas(); renderInicio();
    form.reset();
    delete form.dataset.editing;
    saveBtn.textContent = prevText;
    form.removeEventListener('submit', onSubmit);
  };
  form.addEventListener('submit', onSubmit);
}

/* ---------- CATEGORIES (bubbles with automatic colors) ---------- */
function colorForIndex(i){ return palette[i % palette.length]; }
function softForIndex(i){ return soft[i % soft.length]; }

function renderCategorias(){
  const grid = $('#catGrid'); grid.innerHTML = '';
  categories.forEach((c, idx)=>{
    const color = colorForIndex(idx);
    const bg = softForIndex(idx);
    const card = document.createElement('div'); card.className='cat-card fade-in';
    card.style.background = color; card.dataset.idx = idx;
    card.innerHTML = `<div style="text-align:center;pointer-events:none"><div style="font-size:15px">${esc(c)}</div></div>`;
    const actions = document.createElement('div'); actions.className='cat-actions';
    const editBtn = document.createElement('button'); editBtn.className='cat-btn'; editBtn.style.background='rgba(255,255,255,0.95)'; editBtn.style.color=color; editBtn.textContent='‚úèÔ∏è';
    const delBtn = document.createElement('button'); delBtn.className='cat-btn'; delBtn.style.background='rgba(0,0,0,0.06)'; delBtn.style.color='#111'; delBtn.textContent='üóëÔ∏è';
    actions.appendChild(editBtn); actions.appendChild(delBtn);
    const wrapper = document.createElement('div'); wrapper.style.display='flex'; wrapper.style.flexDirection='column'; wrapper.style.alignItems='center'; wrapper.style.maxWidth='140px';
    wrapper.appendChild(card); wrapper.appendChild(actions);
    editBtn.addEventListener('click', ()=> {
      // inline edit
      card.style.display='none'; actions.style.display='none';
      const box = document.createElement('div'); box.style.display='flex'; box.style.flexDirection='column'; box.style.alignItems='center'; box.style.width='120px';
      const input = document.createElement('input'); input.className='field'; input.style.width='100%'; input.value = c;
      const btns = document.createElement('div'); btns.style.display='flex'; btns.style.gap='8px'; btns.style.marginTop='8px';
      const save = document.createElement('button'); save.className='btn btn-primary'; save.textContent='Guardar';
      const cancel = document.createElement('button'); cancel.className='btn btn-ghost'; cancel.textContent='Cancelar';
      btns.appendChild(save); btns.appendChild(cancel); box.appendChild(input); box.appendChild(btns); wrapper.appendChild(box);
      input.focus();
      save.addEventListener('click', ()=>{
        const nv = input.value.trim(); if(!nv) return alert('Nombre inv√°lido'); if(categories.includes(nv) && nv!==c) return alert('La categor√≠a ya existe');
        categories[idx] = nv; saveAll(); renderCategorias(); renderMovimientos(); renderBalances();
      });
      cancel.addEventListener('click', ()=> { box.remove(); card.style.display=''; actions.style.display=''; });
    });
    delBtn.addEventListener('click', ()=>{
      wrapper.classList.add('fade-out');
      setTimeout(()=> {
        const rem = categories.splice(idx,1)[0];
        movimientos.forEach(m => { if(m.categoria===rem) m.categoria='Otros'; });
        if(!categories.includes('Otros')) categories.push('Otros');
        saveAll(); renderCategorias(); renderMovimientos(); renderBalances(); updateGlobalSaldo();
      },260);
    });
    grid.appendChild(wrapper);
  });
  // update mov category select
  const sel = $('#movCategoria'); if(sel){ sel.innerHTML = '<option value="">-- Selecciona --</option>'; categories.forEach(c=> sel.insertAdjacentHTML('beforeend', `<option value="${esc(c)}">${esc(c)}</option>`)); }
}
$('#addCatBtn').addEventListener('click', ()=>{
  const name = $('#newCatName').value.trim(); if(!name) return alert('Escribe un nombre'); if(categories.includes(name)) return alert('La categor√≠a ya existe');
  categories.push(name); $('#newCatName').value=''; saveAll(); renderCategorias(); renderBalances();
});

/* ---------- MOVIMIENTOS ---------- */
$('#formMov').addEventListener('submit', e=>{
  e.preventDefault();
  const id = $('#movId').value || uid();
  const tipo = $('#movTipo').value;
  const importe = Number($('#movImporte').value || 0);
  const fecha = $('#movFecha').value || new Date().toISOString().slice(0,10);
  const categoria = $('#movCategoria').value || 'Otros';
  const concepto = $('#movConcepto').value.trim() || '';
  const ex = movimientos.find(m=>m.id===id);
  if(ex){ Object.assign(ex,{tipo,importe,fecha,categoria,concepto}); }
  else movimientos.unshift({id,tipo,importe,fecha,categoria,concepto,created:new Date().toISOString()});
  saveAll();
  $('#formMov').reset(); $('#movId').value=''; renderMovimientos(); renderBalances(); updateGlobalSaldo();
});
$('#limpiarMov').addEventListener('click', ()=> { $('#formMov').reset(); $('#movId').value=''; });

function renderMovimientos(){
  const lista = $('#listaMovimientos');
  if(movimientos.length===0){ lista.innerHTML = '<div class="small muted">Sin movimientos</div>'; return; }
  lista.innerHTML = movimientos.slice(0,50).map(m=>`
    <div class="p-2 border rounded mb-2 flex justify-between items-start">
      <div><div class="font-semibold">${esc(m.concepto || m.categoria)}</div><div class="small text-gray-500">${esc(m.fecha)} ‚Ä¢ ${esc(m.categoria)}</div></div>
      <div class="text-right"><div class="${m.tipo==='ingreso'?'text-emerald-600':'text-rose-600'} font-semibold">${m.tipo==='ingreso'?'+':'-'}${Number(m.importe).toFixed(2)} ‚Ç¨</div>
        <div class="flex gap-2 mt-2"><button data-id="${m.id}" class="edit-mov btn btn-ghost">Editar</button><button data-id="${m.id}" class="del-mov btn btn-ghost">Borrar</button></div></div>
    </div>`).join('');
  $all('.edit-mov').forEach(b=> b.addEventListener('click', e=>{
    const id = e.currentTarget.dataset.id; const mv = movimientos.find(x=>x.id===id); if(!mv) return;
    $('#movId').value = mv.id; $('#movTipo').value = mv.tipo; $('#movImporte').value = mv.importe; $('#movFecha').value = mv.fecha; $('#movCategoria').value = mv.categoria; $('#movConcepto').value = mv.concepto; showSection('contabilidad');
  }));
  $all('.del-mov').forEach(b=> b.addEventListener('click', e=>{
    const id = e.currentTarget.dataset.id; movimientos = movimientos.filter(m=> m.id !== id); saveAll(); renderMovimientos(); renderBalances(); updateGlobalSaldo();
  }));
}

/* ---------- RESERVAS & CALENDAR ---------- */
$('#formRes').addEventListener('submit', e=>{
  e.preventDefault();
  const nombre = $('#resNombre').value.trim(); const fecha = $('#resFecha').value; const hora = $('#resHora').value; const pax = Number($('#resPax').value||1);
  if(!nombre || !fecha) return alert('Nombre y fecha requeridos');
  reservas.unshift({id: uid(), nombre, fecha, hora, pax, created: new Date().toISOString()});
  saveAll(); $('#formRes').reset(); renderReservas(); renderInicio(); renderCalendar(currentYear, currentMonth);
});
$('#limpiarRes').addEventListener('click', ()=> $('#formRes').reset());

function renderReservas(){
  $('#listaReservas').innerHTML = reservas.slice().sort((a,b)=> a.fecha.localeCompare(b.fecha)).slice(0,10).map(r=>`<div class="p-2 border rounded mb-2"><div class="font-semibold">${esc(r.nombre)}</div><div class="small text-gray-500">${esc(r.fecha)} ${esc(r.hora||'')} ‚Ä¢ ${esc(r.pax)} pax</div></div>`).join('') || '<div class="small muted">No hay reservas</div>';
  $('#cntReservas').textContent = reservas.length;
}

/* Calendar rendering and navigation */
let now = new Date();
let currentYear = now.getFullYear();
let currentMonth = now.getMonth(); // 0-based
function renderCalendar(year, month){
  currentYear = year; currentMonth = month;
  const cal = $('#calendar'); cal.innerHTML = '';
  const first = new Date(year, month, 1);
  const startDay = first.getDay(); // 0..6 (Sun..Sat)
  const daysInMonth = new Date(year, month+1, 0).getDate();
  const prevDays = startDay;
  // show month title
  const monthNames = ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
  $('#calMonth').textContent = `${monthNames[month]} ${year}`;
  // build grid: fill previous month's blanks
  const totalCells = Math.ceil((prevDays + daysInMonth)/7)*7;
  for(let i=0;i<totalCells;i++){
    const cell = document.createElement('div'); cell.className='cal-day';
    const dayIndex = i - prevDays + 1;
    if(dayIndex < 1 || dayIndex > daysInMonth){
      cell.classList.add('other');
      cell.innerHTML = `<div class="date muted">&nbsp;</div>`;
    } else {
      const dateStr = `${year}-${String(month+1).padStart(2,'0')}-${String(dayIndex).padStart(2,'0')}`;
      const dayRes = reservas.filter(r=> r.fecha === dateStr);
      cell.innerHTML = `<div class="date">${dayIndex}</div>`;
      if(dayRes.length){
        // show colored dots for each reservation (up to 3)
        const dots = document.createElement('div');
        dayRes.slice(0,3).forEach((d,ii)=> {
          const el = document.createElement('span'); el.className='dot'; el.style.marginRight='6px';
          el.style.background = palette[ii % palette.length];
          dots.appendChild(el);
        });
        const more = dayRes.length>3 ? `<div class="small muted">${dayRes.length} reservas</div>` : '';
        const wrap = document.createElement('div'); wrap.appendChild(dots);
        cell.appendChild(dots);
        if(more) cell.insertAdjacentHTML('beforeend', more);
      }
      cell.addEventListener('click', ()=> {
        showReservasDia(dateStr);
      });
    }
    cal.appendChild(cell);
  }
}

/* Show reservas of a specific day */
function showReservasDia(dateStr){
  const list = reservas.filter(r=> r.fecha === dateStr).sort((a,b)=> a.hora.localeCompare(b.hora));
  const container = $('#listaReservasDia'); container.innerHTML = `<div class="font-semibold">Reservas ${dateStr}</div>`;
  if(list.length===0){ container.insertAdjacentHTML('beforeend','<div class="small muted">No hay reservas para este d√≠a</div>'); return; }
  list.forEach(r=>{
    container.insertAdjacentHTML('beforeend', `<div class="p-2 border rounded mb-2"><div class="font-semibold">${esc(r.nombre)}</div><div class="small text-gray-500">${esc(r.hora||'')} ‚Ä¢ ${esc(r.pax)} pax</div></div>`);
  });
}

/* Calendar nav */
$('#calPrev').addEventListener('click', ()=> { const m = currentMonth-1; const y = m<0 ? currentYear-1 : currentYear; const mm = (m+12)%12; renderCalendar(y, mm); });
$('#calNext').addEventListener('click', ()=> { const m = currentMonth+1; const y = m>11 ? currentYear+1 : currentYear; const mm = m%12; renderCalendar(y, mm); });

/* ---------- BALANCES (period filtering + colored rows) ---------- */
function getDateRangeFromPeriod(period){
  const today = new Date();
  if(period === 'all') return [null,null];
  if(period === '30'){ const from = new Date(); from.setDate(today.getDate()-30); return [from.toISOString().slice(0,10), today.toISOString().slice(0,10)]; }
  if(period === '90'){ const from = new Date(); from.setDate(today.getDate()-90); return [from.toISOString().slice(0,10), today.toISOString().slice(0,10)]; }
  if(period === 'year'){ const from = new Date(today.getFullYear(),0,1); return [from.toISOString().slice(0,10), today.toISOString().slice(0,10)]; }
  return [null,null];
}

$('#periodoSelect').addEventListener('change', ()=> {
  const v = $('#periodoSelect').value;
  if(v === 'custom'){ $('#periodFrom').style.display='inline-block'; $('#periodTo').style.display='inline-block'; }
  else { $('#periodFrom').style.display='none'; $('#periodTo').style.display='none'; }
});
$('#aplicarPeriodo').addEventListener('click', ()=> renderBalances());

function renderBalances(){
  // determine date range
  const p = $('#periodoSelect').value;
  let from=null,to=null;
  if(p==='custom'){ from = $('#periodFrom').value || null; to = $('#periodTo').value || null; }
  else { [from,to] = getDateRangeFromPeriod(p); }
  // prepare summary
  const summary = {};
  categories.concat(['Otros']).forEach((c)=> summary[c] = {ing:0,gas:0});
  movimientos.forEach(m=>{
    const fecha = m.fecha;
    if(from && fecha < from) return;
    if(to && fecha > to) return;
    const c = m.categoria || 'Otros';
    if(!summary[c]) summary[c] = {ing:0,gas:0};
    if(m.tipo === 'ingreso') summary[c].ing += Number(m.importe||0);
    else summary[c].gas += Number(m.importe||0);
  });
  const tbody = $('#tablaBalances tbody'); tbody.innerHTML = '';
  let totalIng=0,totalGas=0;
  Object.keys(summary).forEach((cat,idx)=>{
    const ing = summary[cat].ing, gas = summary[cat].gas, bal = ing - gas;
    totalIng += ing; totalGas += gas;
    const tr = document.createElement('tr');
    const bg = softForIndex(idx);
    tr.style.background = bg;
    tr.innerHTML = `<td class="small font-semibold">${esc(cat)}</td><td>${ing.toFixed(2)}</td><td>${gas.toFixed(2)}</td><td>${bal.toFixed(2)}</td>`;
    tbody.appendChild(tr);
  });
  $('#sumIngresos').textContent = totalIng.toFixed(2);
  $('#sumGastos').textContent = totalGas.toFixed(2);
  $('#sumSaldo').textContent = (totalIng-totalGas).toFixed(2);
}

/* ---------- Global updates ---------- */
function updateGlobalSaldo(){
  const ingresos = movimientos.filter(m=>m.tipo==='ingreso').reduce((s,m)=>s+Number(m.importe||0),0);
  const gastos = movimientos.filter(m=>m.tipo==='gasto').reduce((s,m)=>s+Number(m.importe||0),0);
  $('#saldoGlobal').textContent = (ingresos-gastos).toFixed(2) + ' ‚Ç¨';
}

/* ---------- Options modal (export/import/reset) ---------- */
$('#btnOptions').addEventListener('click', ()=> {
  const root = document.getElementById('modalRoot'); root.innerHTML = '';
  const overlay = document.createElement('div'); overlay.className='modal-overlay';
  const modal = document.createElement('div'); modal.className='modal';
  modal.innerHTML = `<div style="font-weight:700;margin-bottom:8px">Opciones</div>
  <div style="display:flex;flex-direction:column;gap:8px">
    <button id="expBtn" class="btn btn-primary">Exportar datos (descarga JSON)</button>
    <button id="impOpen" class="btn btn-ghost">Importar datos (pegar JSON)</button>
    <button id="resetOpen" class="btn btn-ghost">Reiniciar datos</button>
    <button id="closeBtn" class="btn btn-ghost">Cerrar</button>
  </div>`;
  overlay.appendChild(modal); root.appendChild(overlay);
  $('#closeBtn', modal).onclick = ()=> root.innerHTML = '';
  $('#expBtn', modal).onclick = ()=> {
    const data = {recetas, categories, movimientos, reservas};
    const a = document.createElement('a');
    a.href = 'data:application/json;charset=utf-8,'+encodeURIComponent(JSON.stringify(data,null,2));
    a.download = 'ajop_data.json'; a.click();
  };
  $('#impOpen', modal).onclick = ()=> {
    modal.innerHTML = `<div style="font-weight:700;margin-bottom:8px">Importar JSON</div>
      <textarea id="impText" style="width:100%;height:160px;padding:8px;border:1px solid #e5e7eb;border-radius:8px"></textarea>
      <div style="display:flex;gap:8px;margin-top:8px"><button id="doImp" class="btn btn-primary">Importar</button><button id="impCancel" class="btn btn-ghost">Cancelar</button></div>`;
    $('#impCancel').onclick = ()=> root.innerHTML = '';
    $('#doImp').onclick = ()=> {
      try{ const obj = JSON.parse($('#impText').value); recetas = obj.recetas||[]; categories = obj.categories||categories; movimientos = obj.movimientos||[]; reservas = obj.reservas||[]; saveAll(); renderAll(); root.innerHTML=''; alert('Importado'); }
      catch(e){ alert('JSON inv√°lido'); }
    }
  };
  $('#resetOpen', modal).onclick = ()=> {
    modal.innerHTML = `<div style="font-weight:700;margin-bottom:8px">Reiniciar datos</div><div class="small muted">Escribe REINICIAR para confirmar</div><input id="confirmReset" class="field" placeholder="REINICIAR"><div style="display:flex;gap:8px;margin-top:8px"><button id="doReset" class="btn btn-primary">Reiniciar</button><button id="resetCancel" class="btn btn-ghost">Cancelar</button></div>`;
    $('#resetCancel').onclick = ()=> root.innerHTML='';
    $('#doReset').onclick = ()=> { if($('#confirmReset').value.trim()!=='REINICIAR'){ alert('Escribe REINICIAR'); return; } recetas=[]; categories=['Cuotas','Eventos','Compras','Otros']; movimientos=[]; reservas=[]; saveAll(); renderAll(); root.innerHTML=''; alert('Reiniciado'); };
  };
});

/* ---------- Render all helpers ---------- */
function renderAll(){ renderCategorias(); renderRecetas(); renderMovimientos(); renderReservas(); renderBalances(); renderInicio(); renderCalendar(currentYear, currentMonth); }
renderAll();

/* init calendar: default month current */
renderCalendar(currentYear, currentMonth);

/* Accessibility: focus first input */
$all('.nav-btn').forEach(btn=> btn.addEventListener('click', ()=> setTimeout(()=>{ const s=document.getElementById(btn.dataset.target); const f = s && s.querySelector('input,textarea,select'); if(f) f.focus(); }, 300) ));

}); // DOMContentLoaded
</script>
</body>
</html>
